---
title: "DescusmrVignette"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DescusmrVignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r,include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning=FALSE,
  message=FALSE
)
```

\


```{r setup}
library(Descusmr)
library(dplyr)
library(tidyr)
library(labelled)
library(rlang)
library(gtsummary)
library(forcats)
```


# Introduction

This vignette demonstrates the different options available for the `desc_var` function, accompanied by examples to illustrate its usage. 
 
# Toy dataset

We will generate a sample dataset to apply the `desc_var` function.


```{r}
# Charger le package nécessaire
set.seed(123)  # Pour garantir la reproductibilité

# Création du data frame
data <- data.frame(
  Age = c(rnorm(45, mean = 50, sd = 10), rep(NA, 5)),  # Renommée Age
  sexe = sample(c(0, 1), 50, replace = TRUE, prob = c(0.6, 0.4)),  # Renommée sexe
  quatre_modalites = sample(c("A", "B", "C"), 50, replace = TRUE, prob = c(0.2, 0.5, 0.3)),  # Modalités sans "D"
  traitement = sample(c("BRAS-A", "BRAS-B"), 50, replace = TRUE, prob = c(0.55, 0.45)),  # Nouvelle variable traitement
  echelle = sample(0:5, 50, replace = TRUE)  # Nouvelle variable entière de 0 à 5
)

# Ajouter la modalité "D" comme niveau sans effectif
data$quatre_modalites <- factor(data$quatre_modalites, levels = c("A", "B", "C", "D"))

# Ajouter des labels à la variable sexe
data$sexe <- factor(data$sexe, levels = c(0, 1), labels = c("Femme", "Homme"))

# Aperçu des données



data <- data %>% labelled::set_variable_labels( Age = "Age",
                                                sexe = "sexe",
                                                traitement  = "traitement",
                                                quatre_modalites = "quatres niveaux",
                                                echelle = "Echelle")
```

# Basic usage
 
Below, we describe the options used in the example.

The dataset is passed to the `desc_var` function for analysis.

- `table_title`: Title of the descriptive table. Here, it is "test."
- `var_group`: The variable used for grouping the data. Here, it is "traitement."
- `group_title`: Title of the grouping variable column. Here, it is "traitement."
- `group`: Indicates whether to create both grouped and ungrouped descriptions using the "ALL" option.


```{r}
data %>% Descusmr::desc_var(table_title = "test",
             var_group = "traitement",
             group_title = "traitement",
             group = "ALL")
```


# Feature Data Management

In the previous example, no specific data management operations were applied.

## Order of categorical features

In this example, we add `DM = "tri"`, which orders the categories of categorical variables in descending order based on their counts.

```{r second example}
data %>% desc_var(table_title = "test",
             var_group = "traitement",
             group_title = "traitement",
             group = "ALL", 
             DM = "tri")
```


## Remove zero-count levels


Here, we remove levels with a zero count.

```{r third example}
data %>% desc_var(table_title = "test",
             var_group = "traitement",
             group_title = "traitement",
             group = "ALL", 
             DM = "remove")
```

## Both


In this example, both previous data management operations are performed simultaneously using `DM = "ALL"`. Additionally, we specify the variable `echelle` as quantitative (even though it is treated as qualitative by default) using the `quanti` argument. If multiple variables are to be specified, they should be listed in a vector.

```{r}

data %>% Descusmr::desc_var(table_title = "test",
             quanti = "echelle",
             var_group = "traitement",
             group_title = "traitement",
             group = "ALL", 
             DM = "tout")
```


# Overall and Per-Group Descriptions

## Per-Group Description

Here, we use a per-group description for the variables.

```{r }
data %>% desc_var(table_title = "test",
             var_group = "traitement",
             group_title = "traitement",
             group = TRUE, 
             DM = "tout")
```

## Overall Description

In this example, we generate a global description of the variables.

```{r}
data %>% Descusmr::desc_var(table_title = "test", group = FALSE)
```

# Intermediate titles

To insert intermediate titles, you can use the `intermediate_header` function which takes a list of sub-tables generated by `desc_var` and a vector of titles.

```{r}
tb1 <- data %>%
  dplyr::select(Age, sexe) %>%
  Descusmr::desc_var(table_title = "test", group = FALSE)

tb2 <- data %>%
  dplyr::select(quatre_modalites) %>%
  Descusmr::desc_var(table_title = "test", group = FALSE)

Descusmr::intermediate_header(tbls = list(tb1, tb2),
                              group_header = c("Title A", "Title B"))

```

# Number of Digits in Quantitative and Qualitative Features

You can specify the number of digits for quantiative and qualitative features using the `round_quanti` and `round_quali` arguments, respectively.

## Specify Number of Digits

In the example below, quantitative values are rounded to 0 decimal places, while qualitative values are rounded to 1 decimal place.

```{r}
data %>%
  Descusmr::desc_var(table_title = "test",
                     group = TRUE,
                     var_group = "traitement",
                     round_quanti = 0,
                     round_quali = 1)
```

## Combine Subtables with Different Rounding

To have more control over rounding, you can create subtables with different numbers of digits and combine them into a single table using `gtsummary::tbl_stack`.

```{r}
tb1 <- data %>%
  dplyr::select(Age, sexe, traitement) %>%
  Descusmr::desc_var(table_title = "test",
                     group = TRUE,
                     var_group = "traitement",
                     round_quanti = 0,
                     round_quali = 0)

tb2 <- data %>%
  dplyr::select(quatre_modalites, traitement) %>%
  Descusmr::desc_var(table_title = "test",
                     group = TRUE,
                     var_group = "traitement",
                     round_quanti = 2,
                     round_quali = 2)

gtsummary::tbl_stack(list(tb1, tb2))

```

# Statistical tests

## Add Default Statistical Tests

You can include statistical tests in your summary table using the `tests = TRUE` argument. This automatically applies default statistical tests for the grouped variables.

The following example adds statistical tests for all features, grouped by the `traitement` variable.

```{r}
data %>%
  Descusmr::desc_var(table_title = "test",
                     group = TRUE,
                     var_group = "traitement",
                     tests = TRUE)
```

## Specify Statistical Tests for Each Feature

For greater control, you can specify the test to use for each feature by passing a named list to the tests argument. The example below applies:

- t-test for Age,
- Chi-squared test for sexe, and
- Fisher's exact test for echelle.

```{r}
data %>%
  Descusmr::desc_var(table_title = "test",
                     group = TRUE,
                     var_group = "traitement",
                     tests = list(Age = "t.test",
                                  sexe = "chisq.test",
                                  echelle = "fisher.test"))
```


